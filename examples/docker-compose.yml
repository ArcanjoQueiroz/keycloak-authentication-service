version: '2.1'
services:
    oracle:
        image: orangehrm/oracle-xe-11g:latest
        hostname: "oracle"
        container_name: oracle
        volumes:
            - ./local-initdb:/etc/entrypoint-initdb.d
            - oracle-storage:/usr/lib/oracle/xe/oradata/XE
        ports:
            - "1521:1521"
        expose:
            - "1521"

    liquibase:
        build: ./liquibase
        hostname: liquibase
        container_name: liquibase
        depends_on: 
            - oracle
        volumes:
            - ./liquibase/jdbc:/liquibase/jdbc:ro
            - ./liquibase/changelog:/liquibase/changelog:ro
        environment:
          TZ: GMT
          WAIT_HOSTS: oracle:1521
          WAIT_HOSTS_TIMEOUT: 300
          WAIT_SLEEP_INTERVAL: 30
          WAIT_HOST_CONNECT_TIMEOUT: 30     
        command: sh -c "/wait && liquibase 
          --driver=oracle.jdbc.driver.OracleDriver 
          --classpath=/liquibase/changelog:/liquibase/jdbc/ojdbc7.jar 
          --url=jdbc:oracle:thin:@oracle:1521/xe 
          --changeLogFile=changelog.xml 
          --username=system 
          --password=oracle migrate"

    keycloak:
        image: authentication-service:latest
        container_name: keycloak_server
        ports:
          - "9999:8080"
          - "8787:8787"
        environment:
          JAVA_OPTS: '-agentlib:jdwp=transport=dt_socket,address=*:8787,server=y,suspend=n -Djava.net.preferIPv4Stack=true'
          KEYCLOAK_USER: 'admin'
          KEYCLOAK_PASSWORD: 'admin'
          DB_VENDOR: 'oracle'
          JDBC_PARAMS: 'connectTimeout=240'
          DB_HOST: 'oracle'
          DB_PORT: 1521
          DB_DATABASE: 'xe'
          DB_USER: 'system'
          DB_PASSWORD: 'oracle'
          TZ: GMT

volumes:
  oracle-storage:
    external: true

